---
- name: Install required packages
  package:
    name:
      - joystick
      - mednafen
    state: present
  become: yes
  when: ansible_system == "Linux"

- name: Create Mednafen configuration directory
  file:
    path: "{{ mednafen_config_dir }}"
    state: directory
    mode: '0755'
  when: ansible_system == "Linux"

- name: Create ROM directory
  file:
    path: "{{ rom_dir }}"
    state: directory
    mode: '0755'
  when: ansible_system == "Linux"

- name: Download Sonic & Knuckles ROM
  get_url:
    url: "{{ sonic_knuckles_rom_url }}"
    dest: "{{ rom_dir }}/Sonic & Knuckles (World).zip"
    mode: '0644'
  when:
    - ansible_system == "Linux"
    - sonic_knuckles_rom_url is defined
    - not (lookup('file', '{{ rom_dir }}/Sonic & Knuckles (World).zip') is defined)

- name: Create Mednafen configuration file
  copy:
    content: |
      # Mednafen Configuration for Gaming
      # Generated by Ansible

      # Audio Settings
      sound.driver {{ audio_driver }}
      sound.device {{ audio_device }}
      sound.periods {{ audio_periods }}
      sound.rate {{ audio_rate }}
      sound.buffer_time {{ audio_buffer_time }}

      # Genesis/Mega Drive Settings
      md.xscale {{ md_xscale }}
      md.yscale {{ md_yscale }}
      md.special {{ md_special }}
      md.region {{ md_region }}
      md.correct_aspect {{ md_correct_aspect }}
      md.ym2413 {{ md_ym2413 }}

      # Controller Settings
      input.port1 {{ input_port1 }}
      input.port1.gamepad.a "joystick {{ controller_port }} 0"
      input.port1.gamepad.b "joystick {{ controller_port }} 1"
      input.port1.gamepad.c "joystick {{ controller_port }} 2"
      input.port1.gamepad.start "joystick {{ controller_port }} 3"
      input.port1.gamepad.up "joystick {{ controller_port }} 1"
      input.port1.gamepad.down "joystick {{ controller_port }} 1"
      input.port1.gamepad.left "joystick {{ controller_port }} 0"
      input.port1.gamepad.right "joystick {{ controller_port }} 0"

      # Video Settings
      video.driver {{ video_driver }}
      video.fs {{ video_fs }}
      video.xscale {{ video_xscale }}
      video.yscale {{ video_yscale }}
      video.xscalefs {{ video_xscalefs }}
      video.yscalefs {{ video_yscalefs }}
      video.special none
      video.softfb 0
      video.hlsl 0
      video.glvsync 1
      video.pixshader none
      video.shader none
      video.disable_composition 0
      video.disable_screensaver 1

      # Input Settings
      input.autofire_freq 0
      input.ckdelay 0
      input.mouse_sensitivity 1.00
      input.joystick.axis_threshold 0.75
      input.joystick.axis_scale 1.00
      input.joystick.axis_dead 0.00
    dest: "{{ mednafen_config_dir }}/mednafen.cfg"
    mode: '0644'
  when: ansible_system == "Linux"

- name: Create applications directory
  file:
    path: "{{ applications_dir }}"
    state: directory
    mode: '0755'
  when: ansible_system == "Linux"

- name: Create desktop launcher
  copy:
    content: |
      [Desktop Entry]
      Version=1.0
      Type=Application
      Name=Sonic & Knuckles
      Comment=Play Sonic & Knuckles with Mednafen
      Exec=mednafen "{{ rom_dir }}/Sonic & Knuckles (World).zip"
      Icon=applications-games
      Terminal=false
      Categories=Game;Emulator;
      StartupNotify=true
      MimeType=application/x-genesis-rom;
    dest: "{{ applications_dir }}/sonic-knuckles.desktop"
    mode: '0755'
  when: ansible_system == "Linux"
